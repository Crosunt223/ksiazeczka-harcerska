<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KsiƒÖ≈ºeczka Harcerska - Le≈õna Szk√≥≈Çka</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- STYLE IDENTYCZNE Z ORYGINA≈ÅEM --- */
        :root { --primary-dark: #1b3a28; --primary: #2e7d32; --primary-light: #4caf50; --accent: #ff6f00; --bg-body: #f7f9f5; --bg-panel: #ffffff; --bg-input: #f8fafc; --text-main: #2c3e50; --text-muted: #7f8c8d; --border-color: #e2e8f0; --shadow-soft: 0 8px 24px rgba(0,0,0,0.08); --font-size-base: 16px; --border-radius: 16px; }
        body.dark-mode { --bg-body: #121212; --bg-panel: #1e1e1e; --bg-input: #2c2c2c; --text-main: #e0e0e0; --text-muted: #a0a0a0; --border-color: #333333; }
        body { margin: 0; font-family: 'Open Sans', sans-serif; background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; font-size: var(--font-size-base); }
        .sidebar { width: 300px; background: var(--bg-panel); display: flex; flex-direction: column; border-right: 1px solid var(--border-color); z-index: 1000; }
        .brand { padding: 30px 20px; text-align: center; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; cursor: pointer; }
        .nav-list { flex: 1; overflow-y: auto; list-style: none; padding: 0 10px; }
        .nav-item { padding: 12px 15px; cursor: pointer; border-radius: 10px; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .nav-item.active { background: var(--primary); color: white; }
        .main { flex: 1; overflow-y: auto; padding: 40px 20px; }
        #loginOverlay { position: fixed; inset: 0; background: linear-gradient(135deg, #1b3a28, #2e7d32); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 320px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .login-box input, .login-box select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 12px; background: #2e7d32; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .header-section { background: var(--bg-panel); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow-soft); margin-bottom: 30px; border-left: 6px solid var(--accent); }
        .cb-container { display: flex; align-items: center; background: var(--bg-panel); padding: 15px; border-radius: 12px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; }
        .settings-fab { position: fixed; bottom: 20px; left: 20px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; border: none; cursor: pointer; font-size: 24px; z-index: 4000; }
        .settings-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 4001; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .settings-content { background: var(--bg-panel); padding: 30px; border-radius: 20px; width: 300px; text-align: center; }
        .btn-danger { background: #fee2e2; color: #dc2626; border: none; padding: 12px; width: 100%; border-radius: 8px; cursor: pointer; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2 id="authTitle">Czuwaj!</h2>
        <input type="text" id="userInp" placeholder="Login">
        <input type="text" id="nameInp" placeholder="Twoje Imiƒô/Pseudonim" style="display:none">
        <select id="teamInp" style="display:none">
            <option value="" disabled selected>Wybierz dru≈ºynƒô</option>
            <option value="team_las">Le≈õne Skrzaty</option>
            <option value="team_woda">Wodne Wilki</option>
        </select>
        <input type="password" id="passInp" placeholder="Has≈Ço">
        <button onclick="handleAuth()">Zaloguj siƒô</button>
        <p id="authToggle" style="cursor:pointer; font-size:0.85em; margin-top:15px; color:#2e7d32" onclick="toggleAuthMode()">Nie masz konta? Zarejestruj siƒô</p>
    </div>
</div>

<button class="settings-fab" onclick="document.getElementById('settingsModal').style.display='flex'">‚öôÔ∏è</button>

<div id="settingsModal" class="settings-modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="settings-content">
        <h3>Ustawienia</h3>
        <button class="btn-danger" onclick="deleteMyAccount()">‚ùå Usu≈Ñ moje konto</button>
        <button onclick="location.reload()" style="width:100%; margin-top:10px; padding:10px; border:none; border-radius:8px; cursor:pointer">Wyloguj</button>
    </div>
</div>

<nav class="sidebar" id="sidebar">
    <div class="brand" onclick="goHome()">
        <h1>LE≈öNA SZK√ì≈ÅKA</h1>
        <small>KsiƒÖ≈ºeczka Harcerska</small>
    </div>
    <ul class="nav-list" id="navList"></ul>
</nav>

<main class="main">
    <div id="contentArea"></div>
</main>

<script src="stopnie.js"></script>
<script src="sprawnosci.js"></script>

<script>
    const API = 'http://localhost:3000/api';
    let currentUser = null;
    let isRegisterMode = false;
    let inspectingUser = null; // Kogo oglƒÖda admin

    const DB_CONTENT = [
        ...(typeof stopnieData !== 'undefined' ? stopnieData : []),
        ...(typeof sprawnosciData !== 'undefined' ? sprawnosciData : [])
    ];

    function toggleAuthMode() {
        isRegisterMode = !isRegisterMode;
        document.getElementById('authTitle').innerText = isRegisterMode ? "Do≈ÇƒÖcz do nas!" : "Czuwaj!";
        document.getElementById('nameInp').style.display = isRegisterMode ? 'block' : 'none';
        document.getElementById('teamInp').style.display = isRegisterMode ? 'block' : 'none';
        document.querySelector('.login-box button').innerText = isRegisterMode ? "Zarejestruj siƒô" : "Zaloguj siƒô";
        document.getElementById('authToggle').innerText = isRegisterMode ? "Masz konto? Zaloguj siƒô" : "Nie masz konta? Zarejestruj siƒô";
    }

    async function handleAuth() {
        const payload = {
            username: document.getElementById('userInp').value,
            password: document.getElementById('passInp').value,
            name: document.getElementById('nameInp').value,
            teamId: document.getElementById('teamInp').value
        };

        try {
            const res = await fetch(`${API}/${isRegisterMode ? 'register' : 'login'}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (data.success) {
                if (isRegisterMode) {
                    alert("Konto za≈Ço≈ºone! Poczekaj na akceptacjƒô dru≈ºynowego.");
                    toggleAuthMode();
                } else {
                    currentUser = data.user;
                    inspectingUser = currentUser;
                    initUI();
                }
            } else alert(data.message || "B≈ÇƒÖd logowania");
        } catch (e) { alert("Serwer nie odpowiada!"); }
    }

    function initUI() {
        document.getElementById('loginOverlay').style.display = 'none';
        if (currentUser.status === 'pending') {
            renderPending();
        } else if (currentUser.role === 'admin') {
            renderAdminPanel();
        } else {
            renderSidebar();
            goHome();
        }
    }

    function renderPending() {
        document.getElementById('contentArea').innerHTML = `
            <div class="header-section" style="text-align:center">
                <div style="font-size: 4rem; margin-bottom: 20px;">‚è≥</div>
                <h2>Brak przydzia≈Çu do dru≈ºyny</h2>
                <p>Twoje zg≈Çoszenie zosta≈Ço wys≈Çane. Poczekaj, a≈º admin Twojej dru≈ºyny zaakceptuje Tw√≥j profil.</p>
                <button class="btn-danger" style="width:auto; padding: 10px 30px" onclick="deleteMyAccount()">Anuluj pro≈õbƒô / Usu≈Ñ konto</button>
            </div>`;
    }

    async function renderAdminPanel() {
        const res = await fetch(`${API}/team-members?adminId=${currentUser.id}`);
        const members = await res.json();
        
        const pending = members.filter(m => m.status === 'pending');
        const active = members.filter(m => m.status === 'active');

        let html = `<div class="header-section"><h2>Panel Dru≈ºynowego</h2><p>ZarzƒÖdzasz osobami ze swojej dru≈ºyny.</p></div>`;

        if (pending.length > 0) {
            html += `<h3>Pro≈õby o przyjƒôcie (${pending.length})</h3>`;
            pending.forEach(m => {
                html += `<div class="cb-container" style="justify-content:space-between">
                    <span><strong>${m.name}</strong> (@${m.username})</span>
                    <div>
                        <button onclick="updateUserStatus(${m.id}, 'active')" style="background:#dcfce7; color:#166534; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:bold">Przyjmij</button>
                        <button onclick="deleteOtherUser(${m.id})" style="background:#fee2e2; color:#991b1b; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; margin-left:5px">Odrzuƒá</button>
                    </div>
                </div>`;
            });
        }

        html += `<h3>Twoi Harcerze</h3>`;
        active.forEach(m => {
            html += `<div class="cb-container" style="justify-content:space-between">
                <span onclick="inspectHarcerz(${m.id}, '${m.name}')" style="cursor:pointer; color:var(--primary); font-weight:bold">üë§ ${m.name}</span>
                <button onclick="deleteOtherUser(${m.id})" style="background:none; border:none; cursor:pointer; font-size:1.2rem">üóëÔ∏è</button>
            </div>`;
        });

        document.getElementById('contentArea').innerHTML = html;
        document.getElementById('navList').innerHTML = '';
    }

    async function updateUserStatus(userId, status) {
        await fetch(`${API}/user-status`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId, status })
        });
        renderAdminPanel();
    }

    async function inspectHarcerz(id, name) {
        inspectingUser = { id, name };
        renderSidebar();
        goHome();
    }

    async function deleteMyAccount() {
        if(!confirm("Czy na pewno chcesz usunƒÖƒá swoje konto?")) return;
        await fetch(`${API}/user/${currentUser.id}`, { method: 'DELETE' });
        location.reload();
    }

    async function deleteOtherUser(id) {
        if(!confirm("Czy na pewno chcesz usunƒÖƒá to konto?")) return;
        await fetch(`${API}/user/${id}`, { method: 'DELETE' });
        renderAdminPanel();
    }

    function goHome() {
        const isEditing = currentUser.id !== inspectingUser.id;
        document.getElementById('contentArea').innerHTML = `
            <div class="header-section">
                <h2>Czuwaj, ${inspectingUser.name}!</h2>
                ${isEditing ? `<button onclick="renderAdminPanel()" style="background:var(--primary); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer">‚¨Ö Wr√≥ƒá do panelu</button>` : ''}
            </div>
            <div class="header-section">
                <p>Kliknij w kategoriƒô z boku, aby zobaczyƒá ${isEditing ? 'postƒôpy harcerza' : 'swoje zadania'}.</p>
            </div>`;
    }

    function renderSidebar() {
        const list = document.getElementById('navList');
        list.innerHTML = '';
        DB_CONTENT.forEach(item => {
            const li = document.createElement('li');
            li.className = 'nav-item';
            li.innerHTML = `<span>${item.title}</span>`;
            li.onclick = () => loadTasks(item);
            list.appendChild(li);
        });
    }

    async function loadTasks(item) {
        const res = await fetch(`${API}/progress/${inspectingUser.id}`);
        const userProgress = await res.json();
        
        let html = `<div class="header-section"><h2>${item.title}</h2></div>`;
        item.groups.forEach((g, gIdx) => {
            html += `<h4>${g.name}</h4>`;
            g.tasks.forEach((t, tIdx) => {
                const taskId = `${item.id}-${gIdx}-${tIdx}`;
                const checked = userProgress[taskId] ? 'checked' : '';
                // Tylko admin mo≈ºe zaznaczaƒá zadania
                const disabled = (currentUser.role !== 'admin') ? 'disabled' : '';
                html += `
                    <label class="cb-container" style="${currentUser.role !== 'admin' ? 'cursor:default' : ''}">
                        <input type="checkbox" ${checked} ${disabled} onchange="toggleTask('${taskId}', this.checked)">
                        <span style="margin-left:10px">${t}</span>
                    </label>`;
            });
        });
        document.getElementById('contentArea').innerHTML = html;
    }

    async function toggleTask(taskId, status) {
        await fetch(`${API}/progress`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: inspectingUser.id, taskId, status })
        });
    }
</script>
</body>
</html>

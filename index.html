const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');

const app = express();

// Konfiguracja CORS - akceptuje zapytania z dowolnego źródła
app.use(cors());
app.use(bodyParser.json());

// --- TWOJE DANE (Teams i Users) ---
const TEAMS = [
    { id: 'team_las', name: 'Leśna Szkółka' },
    { id: 'team_woda', name: 'Wodne Wilki' },
    { id: 'team_ogien', name: 'Ogniste Ptaki' }
];

let USERS = [
    { id: 1, username: 'admin1', password: '123', role: 'admin', teamId: 'team_las', name: 'Druh Boruch', status: 'approved' }
];

let USER_PROGRESS = {}; 

// --- ENDPOINTY ---

app.get('/api/teams', (req, res) => {
    res.json(TEAMS);
});

app.post('/api/register', (req, res) => {
    const { username, password, name, teamId } = req.body;
    if (USERS.find(u => u.username === username)) {
        return res.json({ success: false, message: 'Ten login jest już zajęty!' });
    }
    const newUser = { id: Date.now(), username, password, name, teamId, role: 'user', status: 'pending' };
    USERS.push(newUser);
    res.json({ success: true, message: 'Prośba o dołączenie została wysłana!' });
});

app.post('/api/login', (req, res) => {
    const { username, password } = req.body;
    const user = USERS.find(u => u.username === username && u.password === password);
    if (!user) return res.status(401).json({ success: false, message: 'Błędny login lub hasło' });
    if (user.status === 'pending') return res.status(403).json({ success: false, message: 'Konto czeka na akceptację admina' });
    res.json({ success: true, user });
});

app.get('/api/pending-requests', (req, res) => {
    const adminId = parseInt(req.query.adminId);
    const admin = USERS.find(u => u.id === adminId);
    if (!admin || admin.role !== 'admin') return res.status(403).send('Brak uprawnień');
    const pending = USERS.filter(u => u.teamId === admin.teamId && u.status === 'pending');
    res.json(pending);
});

app.post('/api/approve-user', (req, res) => {
    const { adminId, userId } = req.body;
    const user = USERS.find(u => u.id === userId);
    if (user) user.status = 'approved';
    res.json({ success: true });
});

// WAŻNE DLA RENDER: Używamy portu z systemu
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`Serwer pracuje na porcie ${PORT}`);
});
